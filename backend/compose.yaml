# backend/compose.yaml

services:

  kong-config-generator:
    image: alpine:latest
    volumes:
      - ./kong/config:/config
      - ./kong.yml.template:/kong.yml.template
    environment:
      - PROJECT_SERVICE_URL=http://project-service:6001
      - TASK_SERVICE_URL=http://task-service:6002
      - SUBTASK_SERVICE_URL=http://subtask-service:6003
      - NOTIFICATION_SERVICE_URL=http://notification-service:6004
      - COMMENT_SERVICE_URL=http://comment-service:6006
      - EXTENSION_REQUEST_SERVICE_URL=http://extension-request-service:6007 
    command: >
      sh -c "
        apk add --no-cache gettext &&
        envsubst < /kong.yml.template > /config/kong.yml &&
        echo 'Kong configuration generated successfully!'
      "
 
  kong:
    image: kong:latest
    container_name: kong
    restart: always
    depends_on:
      - kong-config-generator
    ports:
      - "8000:8000" # Proxy port
      - "8001:8001" # Admin API port
      - "8443:8443" # Proxy HTTPS port
      - "8444:8444" # Admin API HTTPS port
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: "config/kong.yml"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001, 0.0.0.0:8444 ssl"
    volumes:
      - ./kong/config:/config

  project-service:
    build:
      context: .
      dockerfile: project-service/Dockerfile
    ports:
      - "6001:6001"
    volumes:
      - ./firebase-cred.json:/app/firebase.json:ro
    environment:
      JSON_PATH: "/app/firebase.json"
      DATABASE_URL: "${DATABASE_URL}"

  task-service:
    build:
      context: .  
      dockerfile: task-service/Dockerfile
    ports:
      - "6002:6002"
    volumes:
      - ./firebase-cred.json:/app/firebase.json:ro
    environment:
      JSON_PATH: "/app/firebase.json"
      DATABASE_URL: "${DATABASE_URL}"

  subtask-service:
    build:
      context: .
      dockerfile: subtask-service/Dockerfile
    ports:
      - "6003:6003"
    volumes:
      - ./firebase-cred.json:/app/firebase.json:ro
    environment:
      JSON_PATH: "/app/firebase.json"
      DATABASE_URL: "${DATABASE_URL}"

  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    ports:
      - "6004:6004"
    volumes:
      - ./firebase-cred.json:/app/firebase.json:ro
    environment:
      JSON_PATH: "/app/firebase.json"
      DATABASE_URL: "${DATABASE_URL}"
      EMAIL_SERVICE_URL: "http://email-service:6005"
    depends_on:
      - email-service

  email-service:
    build:
      context: .
      dockerfile: email-service/Dockerfile
    ports:
      - "6005:6005"
    environment:
      SMTP_HOST: "${SMTP_HOST:-smtp.gmail.com}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER}"
      SMTP_PASSWORD: "${SMTP_PASSWORD}"
      FROM_EMAIL: "${FROM_EMAIL}"
      FROM_NAME: "${FROM_NAME:-Task Management System}"
  comment-service:
    build:
      context: .
      dockerfile: comment-service/Dockerfile
    ports:
      - "6006:6006"
    volumes:
      - ./firebase-cred.json:/app/firebase.json:ro
    environment:
      JSON_PATH: "/app/firebase.json"
      DATABASE_URL: "${DATABASE_URL}"


  extension-request-service:
    build:
      context: .
      dockerfile: extension-request-service/Dockerfile
    ports:
      - "6007:6007"
    volumes:
      - ./firebase-cred.json:/app/firebase.json:ro
    environment:
      JSON_PATH: "/app/firebase.json"
      DATABASE_URL: "${DATABASE_URL}"
      NOTIFICATION_SERVICE_URL: "${NOTIFICATION_SERVICE_URL}"
      TASK_SERVICE_URL: "${TASK_SERVICE_URL}"
      SUBTASK_SERVICE_URL: "${SUBTASK_SERVICE_URL}"
    depends_on:
      - notification-service
      - task-service
      - subtask-service